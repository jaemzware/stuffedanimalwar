<!DOCTYPE html>
<html>
    <head>
        <title>{{ENDPOINT}} Canvas Room</title>
        <link rel="Stylesheet" href="/stylebase.css" />
<!--        FOR MOBILE-->
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
        <script type="text/javascript" src="/htmlwriter-canvas.js"></script>
        <script src="/jquery-3.7.1.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
    </head>
<body>
<!--define media objects for animals (images), songs, videos, and auto-responses-->
<script type="text/javascript">
    /**
     * 1. DEFINE CUSTOM ANIMALS, MUSIC, VIDEO, AND RESPONSES **STRONGLY ENCOURAGED**
     */
    let stuffedAnimalMediaObject = {{STUFFED_ANIMAL_MEDIA_OBJECT}};
    let mediaObject = {{MEDIA_OBJECT}};
    let responsesObject = {{RESPONSES_OBJECT}};

    // Check if readonly mode is enabled via URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const isReadonly = urlParams.get('readonly') === 'true';

    //write the web page
    if (isReadonly) {
        // Readonly mode: only show the canvas for demonstration purposes
        writeStuffedAnimalWar(stuffedAnimalMediaObject, true);
        writeAudioFromJson(mediaObject);
        writeMuteButton();
    } else {
        // Normal mode: show all interactive elements
        // Note: Camera controls removed - use the Camera button at bottom to go to /jimcamera
        writeStuffedAnimalWar(stuffedAnimalMediaObject, false);
        writeChatForm(responsesObject);
        writeChatMessagesSection();
        writeAudioFromJson(mediaObject);
        writeMediaUploadSection();
        writeVideoFromJson(mediaObject);
        writePhotosFromJson(mediaObject);
    }
</script>
<script type="text/javascript" src="/stuffedanimalwarmechanics-canvas.js"></script>
<!--DOMContentLoaded audio and video programmatic behavior on next song/video, etc and a random color generator-->
<script type="text/javascript" src="/utilities.js"></script>
<!--emitting and receiving socket events and objects-->
<script type="text/javascript" src="/sockethandler.js"></script>
<!--sockethandler initialization vars-->
<script type="text/javascript">
    /**
     * 2. SET UNIQUE ENDPOINT NAME **REQUIRED**
     */
    endpoint = "{{ENDPOINT}}"; //MUST BE IN INDEX.JS endpoints ARRAY
    /**
     * 3. SET MASTER ALIAS FOR AUDIO DJ AND CLEARBOARD FOR ALL PRIVILEGES **OPTIONAL**
     */
    masterAlias = "{{MASTER_ALIAS}}";
    /**
     * 4. SET UNSPECIFIED ALIAS FOR EMPTY ALIAS CHATTERS **OPTIONAL**
     */
    unspecifiedAlias="{{UNSPECIFIED_ALIAS}}";
    chatSocketEvent = endpoint + 'chatmessage';
    tapSocketEvent = endpoint + 'tapmessage';
    pathSocketEvent = endpoint + 'pathmessage';
    presentImageSocketEvent = endpoint + 'presentimage';
    chatImageSocketEvent = endpoint + 'uploadchatimage';
    chatVideoSocketEvent = endpoint + 'uploadchatvideo';
    connectSocketEvent = endpoint + 'connect';
    disconnectSocketEvent = endpoint + 'disconnect';
    voiceOfferSocketEvent = endpoint + 'voiceoffer';
    voiceAnswerSocketEvent = endpoint + 'voiceanswer';
    voiceIceCandidateSocketEvent = endpoint + 'voiceicecandidate';
    audioControlSocketEvent = endpoint + 'audiocontrol';
    socket = io({
        query: {
            endpoint: endpoint
        },
        transports: ['polling', 'websocket'],
        upgrade: true,
        reconnection: true,
        reconnectionDelay: 1000,
        reconnectionDelayMax: 5000,
        reconnectionAttempts: 5
    });
    // Populate the endpoint info after the DOM is ready (only in normal mode)
    if (!isReadonly) {
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('endpointDisplay').textContent = endpoint || 'none';
            document.getElementById('masterAliasDisplay').textContent = masterAlias || 'none';
            document.getElementById('unspecifiedAliasDisplay').textContent = unspecifiedAlias || 'none';
        });
    } else {
        // Readonly mode: set up mute button functionality and autoplay
        document.addEventListener('DOMContentLoaded', function() {
            const audioPlayer = document.getElementById('jaemzwaredynamicaudioplayer');
            const muteButton = document.getElementById('readonlyMuteButton');

            if (audioPlayer && muteButton) {
                // Start muted by default
                audioPlayer.muted = true;

                // Autoplay muted (browsers allow muted autoplay)
                audioPlayer.play().catch(function(error) {
                    console.log('Autoplay prevented:', error);
                    // If autoplay fails, user can still click the mute button to play
                });

                // Toggle mute/unmute on click
                muteButton.addEventListener('click', function() {
                    audioPlayer.muted = !audioPlayer.muted;
                    muteButton.textContent = audioPlayer.muted ? 'ðŸ”‡' : 'ðŸ”Š';
                    muteButton.style.background = audioPlayer.muted ? 'rgba(0, 0, 0, 0.5)' : 'rgba(0, 0, 0, 0.7)';

                    // Ensure it's playing when unmuting
                    if (!audioPlayer.muted && audioPlayer.paused) {
                        audioPlayer.play();
                    }
                });
            }
        });
    }
    initializeSocketHandlers();
</script>
<!--COLOR PICKER-->
<script src="/modal-color-picker.js"></script>

<script>
    // Set navigation links dynamically based on endpoint (links are in htmlwriter-canvas.js)
    document.addEventListener('DOMContentLoaded', function() {
        const canvasUrl = window.location.origin + '/' + endpoint;
        const cameraUrl = window.location.origin + '/' + endpoint + 'camera';
        const canvasLink = document.getElementById('canvasLink');
        const cameraLink = document.getElementById('cameraLink');
        if (canvasLink) canvasLink.href = canvasUrl;
        if (cameraLink) cameraLink.href = cameraUrl;
    });
</script>


<footer style="text-align: center; padding: 20px; margin-top: 30px; border-top: 1px solid rgba(255, 255, 255, 0.1); color: #999; font-size: 12px;">
    <p style="margin: 5px 0;">&copy; 2025 jaemzware llc</p>
    <p style="margin: 5px 0;"><a href="https://jaemzware.com" target="_blank" style="color: #4a9eff; text-decoration: none;">jaemzware.com</a></p>
    <p style="margin: 5px 0;"><a href="mailto:mrjim@stuffedanimalwar.com" style="color: #4a9eff; text-decoration: none;">mrjim@stuffedanimalwar.com</a></p>
</footer>
</body>
</html>
